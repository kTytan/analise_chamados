<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoramento de SLA</title>
    <style>
        html, body { height: 100%; width: 100%; margin: 0; padding: 0; overflow: hidden; font-family: 'Segoe UI', Arial, sans-serif; background-color: #1e1e1e; color: #f0f0f0; }
        body { display: flex; flex-direction: column; }
        .header-tv { background-color: #0d0d0d; color: white; padding: 8px 15px; text-align: center; font-size: 1.8em; box-shadow: 0 2px 4px rgba(0,0,0,0.6); flex-shrink: 0; }
        .header-tv .title { font-weight: 500; }
        .header-tv .subtitle { font-size: 0.65em; margin-top: 1px; color: #b0b0b0; }
        nav { background-color: #0d0d0d; padding: 10px 0; text-align: center; border-radius: 4px; flex-shrink: 0;}
        nav a { color: white; margin: 0 15px; text-decoration: none; font-size: 1em; padding: 8px 12px; border-radius: 4px; }
        nav a:hover, nav a.active { text-decoration: underline; background-color: #4a6fa5; }
        .tv-main-container-sla { padding: 15px; flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 20px; }
        .filter-section { background-color: #282828; padding: 15px; border-radius: 8px; }
        .filter-section h2 { color: #00bfa5; text-align: left; margin-top: 0; margin-bottom: 15px; font-size: 1.2em; border-bottom: 1px solid #404040; padding-bottom: 8px;}
        .filters-form { display: flex; flex-wrap: wrap; justify-content: flex-start; align-items: flex-end; gap: 15px; }
        .filter-group { display: flex; flex-direction: column; gap: 5px; min-width: 180px; }
        .filter-group label { font-weight: 500; color: #ccc; font-size: 0.9em; text-align: left; }
        .filter-group input, .filter-group select { background-color: #383838; color-scheme: dark; color: #fff; border: 1px solid #555; padding: 8px 12px; border-radius: 5px; font-size: 1em; }
        .filters-form button { background-color: #00bfa5; color: #1e1e1e; font-weight: bold; cursor: pointer; border:none; padding: 8px 20px; border-radius: 5px; }
        .kpi-section { padding: 15px; background-color: #282828; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }
        .kpi-section h2 { color: #00e676; text-align: center; margin-top: 0; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #404040; font-size: 1.5em; }
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; align-items: stretch; }
        .kpi-card { background-color: #333333; padding: 15px 10px; border-radius: 5px; text-align: center; display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 110px; }
        .kpi-card .value { font-size: 3em; font-weight: 600; color: #00d9b2; margin-bottom: 5px; line-height: 1.1; }
        .kpi-card .value.success { color: #28a745; }
        .kpi-card .value.danger { color: #dc3545; }
        .kpi-card .label { font-size: 1.3em; color: #a0a0a0; line-height: 1.2; word-wrap: break-word; }
    </style>
</head>
<body>
    <div class="header-tv">
        <span class="title">Monitoramento de SLA</span>
        <span class="subtitle">Última Atualização: {{ data_atualizacao }}</span>
    </div>
    <nav></nav>

    <div class="tv-main-container-sla">
        <div class="filter-section">
            <h2>Filtros para Chamados Fechados (por Data de Resolução)</h2>
            <form method="GET" action="{{ url_for('dashboard_tv_sla') }}" class="filters-form">
                <input type="hidden" name="data_inicio_abertos" value="{{ data_inicio_abertos }}">
                <input type="hidden" name="data_fim_abertos" value="{{ data_fim_abertos }}">
                <input type="hidden" name="tipo_chamado_abertos" value="{{ tipo_chamado_selecionado_abertos }}">
                <input type="hidden" name="servico_abertos" value="{{ servico_selecionado_abertos }}">
                <input type="hidden" name="filial_abertos" value="{{ filial_selecionada_abertos }}">

                <div class="filter-group"><label for="data_inicio_fechados">Data Início:</label><input type="date" id="data_inicio_fechados" name="data_inicio_fechados" value="{{ data_inicio_fechados }}"></div>
                <div class="filter-group"><label for="data_fim_fechados">Data Fim:</label><input type="date" id="data_fim_fechados" name="data_fim_fechados" value="{{ data_fim_fechados }}"></div>
                <div class="filter-group">
                    <label for="tipo_chamado_fechados">Tipo de Chamado</label>
                    <select name="tipo_chamado_fechados" id="tipo_chamado_fechados">
                        <option value="todos" {% if tipo_chamado_selecionado_fechados == 'todos' %}selected{% endif %}>Todos</option>
                        <option value="incidente" {% if tipo_chamado_selecionado_fechados == 'incidente' %}selected{% endif %}>Incidente</option>
                        <option value="requisicao" {% if tipo_chamado_selecionado_fechados == 'requisicao' %}selected{% endif %}>Requisição</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="servico_fechados">Serviço</label>
                    <select name="servico_fechados" id="servico_fechados">
                        <option value="todos" {% if servico_selecionado_fechados == 'todos' %}selected{% endif %}>Todos</option>
                        {% for s in lista_servicos %}<option value="{{ s.ds_servico }}" {% if s.ds_servico == servico_selecionado_fechados %}selected{% endif %}>{{ s.ds_servico }}</option>{% endfor %}
                    </select>
                </div>
                <div class="filter-group">
                    <label for="filial_fechados">Filial</label>
                    <select name="filial_fechados" id="filial_fechados">
                        <option value="todos" {% if filial_selecionada_fechados == 'todos' %}selected{% endif %}>Todas</option>
                        <option value="portobello_corporativo" {% if filial_selecionada_fechados == 'portobello_corporativo' %}selected{% endif %}>Portobello (Corp)</option>
                        <option value="Portobello Shop" {% if filial_selecionada_fechados == 'Portobello Shop' %}selected{% endif %}>Portobello Shop</option>
                        <option value="Pointer" {% if filial_selecionada_fechados == 'Pointer' %}selected{% endif %}>Pointer</option>
                        <option value="Portobello America" {% if filial_selecionada_fechados == 'Portobello America' %}selected{% endif %}>Portobello America</option>
                    </select>
                </div>
                <button type="submit">Filtrar</button>
            </form>
        </div>

        <section class="kpi-section">
            <h2>Análise de SLA (Chamados Fechados)</h2>
            <div class="kpi-grid">
                <div class="kpi-card"><div class="value">{{ kpis_fechados.total_com_sla }}</div><div class="label">Total com SLA</div></div>
                <div class="kpi-card"><div class="value success">{{ kpis_fechados.dentro_sla }}</div><div class="label">Dentro do SLA</div></div>
                <div class="kpi-card"><div class="value danger">{{ kpis_fechados.fora_sla }}</div><div class="label">Fora do SLA</div></div>
                <div class="kpi-card"><div class="value {{ 'success' if kpis_fechados.taxa_sucesso_sla_str.split('%')[0]|float >= 95 else 'danger' }}">{{ kpis_fechados.taxa_sucesso_sla_str }}</div><div class="label">Taxa de Sucesso</div></div>
                <div class="kpi-card"><div class="value">{{ kpis_fechados.tempo_medio_resolucao_str }}</div><div class="label">T. Médio de Resolução</div></div>
            </div>
        </section>
        
        <div class="filter-section">
            <h2>Filtros para Chamados em Aberto (por Data de Abertura)</h2>
            <form method="GET" action="{{ url_for('dashboard_tv_sla') }}" class="filters-form">
                 <input type="hidden" name="data_inicio_fechados" value="{{ data_inicio_fechados }}">
                 <input type="hidden" name="data_fim_fechados" value="{{ data_fim_fechados }}">
                 <input type="hidden" name="tipo_chamado_fechados" value="{{ tipo_chamado_selecionado_fechados }}">
                 <input type="hidden" name="servico_fechados" value="{{ servico_selecionado_fechados }}">
                 <input type="hidden" name="filial_fechados" value="{{ filial_selecionada_fechados }}">

                <div class="filter-group"><label for="data_inicio_abertos">Data Início:</label><input type="date" id="data_inicio_abertos" name="data_inicio_abertos" value="{{ data_inicio_abertos }}"></div>
                <div class="filter-group"><label for="data_fim_abertos">Data Fim:</label><input type="date" id="data_fim_abertos" name="data_fim_abertos" value="{{ data_fim_abertos }}"></div>
                <div class="filter-group">
                    <label for="tipo_chamado_abertos">Tipo</label>
                    <select name="tipo_chamado_abertos" id="tipo_chamado_abertos">
                        <option value="todos" {% if tipo_chamado_selecionado_abertos == 'todos' %}selected{% endif %}>Todos</option>
                        <option value="incidente" {% if tipo_chamado_selecionado_abertos == 'incidente' %}selected{% endif %}>Incidente</option>
                        <option value="requisicao" {% if tipo_chamado_selecionado_abertos == 'requisicao' %}selected{% endif %}>Requisição</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="servico_abertos">Serviço</label>
                    <select name="servico_abertos" id="servico_abertos">
                        <option value="todos" {% if servico_selecionado_abertos == 'todos' %}selected{% endif %}>Todos</option>
                        {% for s in lista_servicos %}<option value="{{ s.ds_servico }}" {% if s.ds_servico == servico_selecionado_abertos %}selected{% endif %}>{{ s.ds_servico }}</option>{% endfor %}
                    </select>
                </div>
                <div class="filter-group">
                    <label for="filial_abertos">Filial</label>
                    <select name="filial_abertos" id="filial_abertos">
                        <option value="todos" {% if filial_selecionada_abertos == 'todos' %}selected{% endif %}>Todas</option>
                        <option value="portobello_corporativo" {% if filial_selecionada_abertos == 'portobello_corporativo' %}selected{% endif %}>Portobello (Corp)</option>
                        <option value="Portobello Shop" {% if filial_selecionada_abertos == 'Portobello Shop' %}selected{% endif %}>Portobello Shop</option>
                        <option value="Pointer" {% if filial_selecionada_abertos == 'Pointer' %}selected{% endif %}>Pointer</option>
                        <option value="Portobello America" {% if filial_selecionada_abertos == 'Portobello America' %}selected{% endif %}>Portobello America</option>
                    </select>
                </div>
                <button type="submit">Filtrar</button>
            </form>
        </div>

        <section class="kpi-section">
            <h2>Análise de SLA (Chamados em Aberto)</h2>
            <div class="kpi-grid">
                <div class="kpi-card"><div class="value">{{ kpis_abertos.total_com_sla }}</div><div class="label">Total Ativos com SLA</div></div>
                <div class="kpi-card"><div class="value success">{{ kpis_abertos.dentro_sla }}</div><div class="label">Ainda no Prazo</div></div>
                <div class="kpi-card"><div class="value danger">{{ kpis_abertos.fora_sla }}</div><div class="label">SLA Estourado</div></div>
                <div class="kpi-card"><div class="value {{ 'success' if kpis_abertos.taxa_sucesso_sla_str.split('%')[0]|float >= 95 else 'danger' }}">{{ kpis_abertos.taxa_sucesso_sla_str }}</div><div class="label">Taxa Dentro do Prazo</div></div>
                <div class="kpi-card"><div class="value">{{ kpis_abertos.tempo_medio_decorrido_str }}</div><div class="label">Tempo Médio Decorrido</div></div>
            </div>
        </section>

        {% if sla_por_grupo_graph_html %}
        <section class="chart-section">
            <h2>SLA de Resolução por Grupo (Top 10 piores - Fechados)</h2>
            <div class="chart-container">
                {{ sla_por_grupo_graph_html|safe }}
            </div>
        </section>
        {% endif %}
    </div>
</body>
</html>